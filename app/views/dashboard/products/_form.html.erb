<%= form_with model: [:dashboard, @product] do |f| %>
  <div class="p-4">
    <div class="form-group">
      <label><strong>Buscar foto</strong></label>
      <div class="custom-file">
        <%= f.file_field :photo_product, class:" form-control photo-upload custom-file-input", id:"browse" %>

        <%= f.label :photo_product, class: "custom-file-label" do %>
          Selectione um Arquivo
        <% end %>

      </div>
    </div>
    <div class="p-2 mb-2">
      <h6 class="text-center">Foto do Produto</h6>
      <% if @product.photo_product.attached? %>
        <%= image_tag @product.photo_product.variant(resize_to_limit: [300,500]), class: 'img_prev', style: 'max-width: 300px; max-height: 500px' %>
      <% else %>
        <%= image_tag("sem-imagem.jpg", class: "img_prev", style: 'max-width: 300px;') %>
      <% end %>

    </div>
    <hr>
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <%= f.label :manufacturer_id %><br>
          <%= f.collection_select(:manufacturer_id, Manufacturer.all, :id, :description, {prompt: 'Select'}, class: "form-control select2", required: true) %>
        </div>
        <div class="form-group">
          <%= f.label :group_id %><br>
          <%= f.collection_select(:group_id, Group.all, :id, :description, {prompt: "Selecione"}, class: "form-control select2", required: true) %>
        </div>
        <div class="form-group">
          <%= f.label :family_id %><br>
          <%= f.collection_select(:family_id, Family.all, :id, :description, {prompt: "Selecione"}, class: "form-control select2", required: true) %>
        </div>
        <div class="form-group">
          <%= f.label :tax_classification_id %><br>
          <%= f.collection_select(:tax_classification_id, TaxClassification.all, :id, :description, {prompt: "Selecione"}, class: "form-control select2", required: true) %>
        </div>
        <div class="form-group">
          <%= f.label :code %>
          <%= f.text_field :code, class: "form-control", placeholder: '123456' %>
        </div>
        <div class="form-group form-check">
          <%= f.check_box :active, class: "form-check-input" %>
          <label class="form-check-label" for="exampleCheck1">Produto Ativo</label>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <%= f.label :description %>
          <%= f.text_field :description, class: "form-control", placeholder: 'Meu Produto' %>
        </div>
        <div class="form-group">
          <%= f.label :ean %>
          <%= f.text_field :ean, class: "form-control", placeholder: '7891000061190' %>
        </div>
        <div class="form-group">
          <%= f.label :dun %>
          <%= f.text_field :dun, class: "form-control", placeholder: '1845678901001' %>
        </div>
        <div class="form-group">
          <%= f.label :display %>
          <%= f.text_field :display, class: "form-control", placeholder: '978020137962' %>
        </div>
        <div class="form-group">
          <%= f.label :quantitie %>
          <%= f.text_field :quantitie, class: "form-control", placeholder: '24x200' %>
        </div>
        <div class="form-group form-check">
          <%= f.check_box :detach, class: "form-check-input" %>
          <label class="form-check-label" for="exampleCheck1">Produto Destaque</label>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="text-center ml-3 mt-2">
      <%= f.submit class: 'btn btn-success', data: { disable_with: 'Criando....⌛'} %>
      <%= link_to 'Cancelar', dashboard_products_path, class: "btn btn-danger ml-1" %>
    </div>
  </div>
<% end %>

<script>
$(document).ready(function () {
    var elBrowse  = document.getElementById("browse");
    elBrowse.addEventListener("change", function() {
      var files  = this.files;
      var errors = "";
    
      if (!files) {
        errors += "File upload not supported by your browser.";
      }
      if (files && files[0]) {
        for(var i=0; i<files.length; i++) {
          var file = files[i];
          if ( (/\.(png|jpeg|jpg)$/i).test(file.name) ) {
            var reader = new FileReader();

            reader.onload = function (e) {
              //var image = new Image();

              //image.src = reader.result;

              //image.onload = function() {
              //  console.log(image.height);
              //  console.log(image.width);
              //};
              
              $('.img_prev')
                .attr('src', e.target.result)
                .width(300);
            };

            reader.readAsDataURL(file);
          } else {
            errors += file.name +"\nExtensão do arquivo inválida. São válidos apenas png, jpg e jpeg\n";
          }
        }
      }

      if (errors) {
        alert(errors);
      }
    });

    $('.photo-upload').on('change', function (e) {
         e.target.nextElementSibling.innerHTML = e.target.files[0].name;
    });
});

function readURL(input) {
    if (input.files && input.files[0]) {
      var reader = new FileReader();

      reader.onload = function (e) {
        var image = new Image();

        image.src = reader.result;

        image.onload = function() {
          console.log(image.height);
          console.log(image.width);
        };
        
        $('.img_prev')
          .attr('src', e.target.result)
          .width(300);
      };

      reader.readAsDataURL(input.files[0]);
    }
  }

</script>