<%= form_with model: [:dashboard, @product], class: 'autoload_all' do |f| %>
  <div class="p-4">
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <%= f.label :manufacturer_id %><br>
          <%= collection_select(:manufacturer, :manufacturer_id, Manufacturer.all, :id, :description, {prompt: 'Selecione'}, class: "form-control") %>
        </div>
        <div class="form-group">
          <%= f.label :group_id %><br>
          <%= collection_select(:family, :group_id, Group.all, :id, :description, {prompt: "Selecione"}, class: "form-control") %>
        </div>
        <div class="form-group">
          <%= f.label :family_id %><br>
          <%= collection_select(:product, :family_id, [], :id, :description, {prompt: "Selecione"}, class: "form-control") %>
        </div>
        <div class="form-group">
          <%= f.label :tax_classification_id %><br>
          <%= collection_select(:product, :tax_classification_id, TaxClassification.all, :id, :description, {prompt: "Selecione"}, class: "form-control") %>
        </div>
        <div class="form-group">
          <%= f.label :code %>
          <%= f.text_field :code, class: "form-control" %>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <%= f.label :description %>
          <%= f.text_field :description, class: "form-control" %>
        </div>
        <div class="form-group">
          <%= f.label :ean %>
          <%= f.text_field :ean, class: "form-control" %>
        </div>
        <div class="form-group">
          <%= f.label :dun %>
          <%= f.text_field :dun, class: "form-control" %>
        </div>
        <div class="form-group">
          <%= f.label :display %>
          <%= f.text_field :display, class: "form-control" %>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="text-center ml-3 mt-2">
      <%= f.submit class: 'btn btn-success', data: { disable_with: 'Criando....âŒ›'} %>
      <%= link_to 'Cancelar', dashboard_products_path, class: "btn btn-danger ml-1" %>
    </div>
  </div>
<% end %>
<script>
  $(document).ready(function() { $("#family_group_id").select2(); });
  $(document).ready(function() { $("#group_manufacturer_id").select2(); });
  $(document).ready(function() { $("#product_family_id").select2(); });
  $(document).ready(function() { $("#product_tax_classification_id").select2(); });

  function getManufacturerGroups(manufacturerId, callback) {
  	if (manufacturerId == '') { callback([]); return; }
  	$.ajax(`/dashboard/groups.json?manufacturer_id=${manufacturerId}`)
  		.done(callback)
  		.fail(function() { alert("error"); });
  }
  function getGroupFamilies(groupId, callback) {
  	if (groupId == '') { callback([]); return; }
  	$.ajax(`/dashboard/families.json?group_id=${groupId}`)
  		.done(callback)
  		.fail(function() { alert("error"); });
  }
  function renderSelectOptions(options) {
  	return options.reduce(function(html, option) {
  		return `${html}<option value="${option.id}">${option.description}</option>`;
  	}, '<option value="">Selecione</option>');
  }
  $(document).ready(function() {
  	var manufacturerElement = $(".autoload_all #group_manufacturer_id");
  	var groupElement = $(".autoload_all #family_group_id");
  	var familyElement = $(".autoload_all #product_family_id");
  	manufacturerElement.change(function() {
  		getManufacturerGroups(this.value, function(manufacturerGroups) {
  			groupElement.html(renderSelectOptions(manufacturerGroups));
  		});
  		groupElement.val('').trigger('change');
  	});
  	groupElement.change(function() {
  		getGroupFamilies(this.value, function(groupFamilies) {
  			familyElement.html(renderSelectOptions(groupFamilies));
  		});
  		familyElement.val('').trigger('change');
  	});
  });
</script>
